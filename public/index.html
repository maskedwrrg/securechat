<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat - Real-time Chat Room</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- Include the provided CSS styles here (unchanged from your input) -->
    <style>
        /* Your provided CSS styles are included here */
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <h1 class="auth-title">SecureChat</h1>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="successMessage" class="success-message hidden"></div>
        <!-- Login Form -->
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="loginPassword" required>
            </div>
            <button type="submit" class="auth-btn" id="loginBtn">Sign In</button>
            <div class="auth-switch">
                Don't have an account? <span class="auth-switch-link" id="showRegister">Sign Up</span>
            </div>
        </form>
        <!-- Register Form -->
        <form id="registerForm" class="auth-form hidden">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="registerUsername" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="registerPassword" required>
            </div>
            <button type="submit" class="auth-btn" id="registerBtn">Sign Up</button>
            <div class="auth-switch">
                Already have an account? <span class="auth-switch-link" id="showLogin">Sign In</span>
            </div>
        </form>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="container hidden">
        <div class="sidebar">
            <div class="online-users">
                <h2 class="section-title">Online Users</h2>
                <ul id="userList" class="user-list"></ul>
            </div>
            <div class="files-section">
                <h2 class="section-title">Files</h2>
                <div id="fileUploadArea" class="file-upload-area">
                    <span class="file-upload-text">Drag & drop files here or click to upload</span>
                    <input type="file" id="fileInput" multiple hidden>
                </div>
                <div id="fileList" class="file-list"></div>
            </div>
        </div>
        <div class="main-content">
            <div class="chat-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="currentUser"></span>
                </div>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div id="typingIndicator" class="typing-indicator hidden"></div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
                <button class="file-btn" id="fileBtn" title="Upload File">📎</button>
                <button class="send-btn" id="sendBtn">➤</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO with token authentication
        let socket;
        let currentUserData = null;

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const chatContainer = document.getElementById('chatContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileBtn = document.getElementById('fileBtn');
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileList = document.getElementById('fileList');
        const userList = document.getElementById('userList');
        const currentUser = document.getElementById('currentUser');
        const userAvatar = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');
        const typingIndicator = document.getElementById('typingIndicator');

        // Utility Functions
        function showMessage(element, message, type) {
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
                element.textContent = '';
            }, 5000);
        }

        function clearMessages() {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            successMessage.classList.add('hidden');
            successMessage.textContent = '';
        }

        // Toggle between login and register forms
        showRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            clearMessages();
        });

        showLogin.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            clearMessages();
        });

        // Handle Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUserData = data.user;
                    localStorage.setItem('token', data.token);
                    initializeSocket(data.token);
                    authContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    currentUser.textContent = currentUserData.username;
                    userAvatar.textContent = currentUserData.avatar;
                    loginForm.reset();
                    loadMessages();
                } else {
                    showMessage(errorMessage, data.message || 'Login failed', 'error');
                }
            } catch (err) {
                showMessage(errorMessage, 'An error occurred. Please try again.', 'error');
            } finally {
                loginBtn.disabled = false;
            }
        });

        // Handle Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(successMessage, 'Registration successful! Please log in.', 'success');
                    registerForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    registerForm.reset();
                } else {
                    showMessage(errorMessage, data.message || 'Registration failed', 'error');
                }
            } catch (err) {
                showMessage(errorMessage, 'An error occurred. Please try again.', 'error');
            } finally {
                registerBtn.disabled = false;
            }
        });

        // Initialize Socket.IO
        function initializeSocket(token) {
            socket = io('http://localhost:3000', {
                auth: { token }
            });

            // Socket event handlers
            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('usersUpdate');
            });

            socket.on('connect_error', (err) => {
                showMessage(errorMessage, 'Connection error: ' + err.message, 'error');
                logout();
            });

            socket.on('newMessage', (message) => {
                displayMessage(message);
            });

            socket.on('fileUploaded', (data) => {
                const message = {
                    id: Date.now().toString(),
                    userId: data.user.id,
                    username: data.user.username,
                    text: `📎 ${data.file.name}`,
                    timestamp: data.file.uploadedAt,
                    type: 'file',
                    file: data.file
                };
                displayMessage(message);
                displayFile(data.file);
            });

            socket.on('usersUpdate', (users) => {
                userList.innerHTML = '';
                users.forEach((user) => {
                    const userItem = document.createElement('li');
                    userItem.classList.add('user-item');
                    userItem.innerHTML = `
                <span class="status-indicator"></span>
                ${user.username}
            `;
                    userList.appendChild(userItem);
                });
            });

            socket.on('userTyping', (data) => {
                if (data.isTyping && data.userId !== currentUserData.id) {
                    typingIndicator.textContent = `${data.username} is typing...`;
                    typingIndicator.classList.remove('hidden');
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });

            socket.on('error', (data) => {
                showMessage(errorMessage, data.message, 'error');
            });
        }

        // Load initial messages
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages', {
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });
                const data = await response.json();
                if (response.ok) {
                    data.messages.forEach(displayMessage);
                }
            } catch (err) {
                showMessage(errorMessage, 'Failed to load messages', 'error');
            }
        }

        // Display Message
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (message.userId === currentUserData.id) {
                messageElement.classList.add('own');
            }
            const content = message.type === 'file' ? `
        <div class="file-message">
            <div class="file-icon">📄</div>
            <div class="file-info">
                <div class="file-name">${message.file.name}</div>
                <div class="file-size">${(message.file.size / 1024).toFixed(2)} KB</div>
            </div>
            <div class="file-actions">
                <button class="file-action-btn download-btn">⬇</button>
            </div>
        </div>
    ` : `
        <div class="message-text">${message.text}</div>
    `;
            messageElement.innerHTML = `
        <div class="message-content">
            <div class="message-user">${message.username}</div>
            ${content}
            <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
        </div>
    `;
            if (message.type === 'file') {
                const downloadBtn = messageElement.querySelector('.download-btn');
                downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.href = message.file.path;
                    link.download = message.file.name;
                    link.click();
                });
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Display File in Sidebar
        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.classList.add('file-item');
            fileItem.innerHTML = `
        <div class="file-info">
            <div class="file-icon">📄</div>
            <div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
        </div>
        <div class="file-actions">
            <button class="file-action-btn download-btn">⬇</button>
            <button class="file-action-btn delete-btn">🗑</button>
        </div>
    `;
            const downloadBtn = fileItem.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = file.path;
                link.download = file.name;
                link.click();
            });
            const deleteBtn = fileItem.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/files/${file.id}`, {
                        method: 'DELETE',
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    if (response.ok) {
                        fileItem.remove();
                        showMessage(successMessage, 'File deleted successfully', 'success');
                    } else {
                        const data = await response.json();
                        showMessage(errorMessage, data.message || 'Failed to delete file', 'error');
                    }
                } catch (err) {
                    showMessage(errorMessage, 'An error occurred', 'error');
                }
            });
            fileList.appendChild(fileItem);
        }

        // Handle Send Message
        sendBtn.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (text && socket) {
                socket.emit('sendMessage', { text });
                chatInput.value = '';
                socket.emit('typing', { isTyping: false });
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // Handle Typing Indicator
        let typingTimeout;
        chatInput.addEventListener('input', () => {
            if (socket) {
                socket.emit('typing', { isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('typing', { isTyping: false });
                }, 1000);
            }
        });

        // Handle File Upload
        fileBtn.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
            fileInput.value = '';
        });

        async function handleFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/files/upload', {
                        method: 'POST',
                        headers: { 'x-auth-token': localStorage.getItem('token') },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok) {
                        socket.emit('shareFile', { fileId: data.file.id });
                    } else {
                        showMessage(errorMessage, data.message || 'File upload failed', 'error');
                    }
                } catch (err) {
                    showMessage(errorMessage, 'An error occurred during file upload', 'error');
                }
            }
        }

        // Handle Logout
        logoutBtn.addEventListener('click', logout);

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            localStorage.removeItem('token');
            currentUserData = null;
            chatContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
            chatMessages.innerHTML = '';
            userList.innerHTML = '';
            fileList.innerHTML = '';
        }

        // Auto-scroll chat
        chatMessages.addEventListener('DOMNodeInserted', () => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Check for existing token on page load
        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: { 'x-auth-token': token }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        currentUserData = data.user;
                        initializeSocket(token);
                        authContainer.classList.add('hidden');
                        chatContainer.classList.remove('hidden');
                        currentUser.textContent = currentUserData.username;
                        userAvatar.textContent = currentUserData.avatar;
                        loadMessages();
                    } else {
                        localStorage.removeItem('token');
                    }
                } catch (err) {
                    localStorage.removeItem('token');
                }
            }
        });
    </script>
</body>
</html>